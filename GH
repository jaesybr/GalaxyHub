--[[
    GalaxyUI - Improved Roblox UI Library by AI
    Features:
    - Draggable windows
    - Animated transitions (tab switch, dropdown, toggle)
    - Better dropdown management (auto-closing, inside window, etc)
    - Optional callback return values for stateful elements
    - Window scaling, theme tweaking, easy usage
    - UX polish and more comments
    - Enforced tab button limit
--]]

local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local CoreGui = gethui and gethui() or game:GetService("CoreGui")

if CoreGui:FindFirstChild("GalaxyHub_Project") then 
    CoreGui.GalaxyHub_Project:Destroy() 
end

local TAB_BUTTON_LIMIT = 6 -- You can adjust this limit as needed

local Library = {
    Visible = true,
    Flags = {},
    ToggleKey = Enum.KeyCode.RightShift,
    Theme = {
        MainColor = Color3.fromRGB(18, 18, 22),
        AccentColor = Color3.fromRGB(110, 70, 255),
        OutlineColor = Color3.fromRGB(38, 38, 38),
        FontColor = Color3.fromRGB(235, 235, 235),
        Font = Enum.Font.Code,
    },
    Windows = {}
}

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "GalaxyHub_Project"
ScreenGui.Parent = CoreGui
ScreenGui.Enabled = true
ScreenGui.ResetOnSpawn = false

local function Tween(obj, props, time, ...)
    local info = TweenInfo.new(time or 0.15, ...)
    return TweenService:Create(obj, info, props)
end

local function MakeDraggable(topBar, mainFrame)
    local dragging, dragStart, startPos
    topBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true; dragStart = input.Position; startPos = mainFrame.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            Tween(mainFrame, {
                Position = UDim2.new(
                    startPos.X.Scale, startPos.X.Offset + delta.X,
                    startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            }, 0.08):Play()
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
end

UserInputService.InputBegan:Connect(function(input, gpe)
    if not gpe and input.KeyCode == Library.ToggleKey then
        Library.Visible = not Library.Visible
        ScreenGui.Enabled = Library.Visible
        for _, win in ipairs(Library.Windows) do
            if win._MainFrame then
                win._MainFrame.Visible = Library.Visible
            end
        end
    end
end)

function Library:CreateWindow(Name, Size)
    local Window = { CurrentTab = nil, _Tabs = {}, _DropdownPanels = {}, _MainFrame = nil }
    local XSize = (Size and Size.X) or 550
    local YSize = (Size and Size.Y) or 500

    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.fromOffset(XSize, YSize)
    MainFrame.Position = UDim2.new(0.5, -XSize/2, 0.5, -YSize/2)
    MainFrame.BackgroundColor3 = Library.Theme.MainColor
    MainFrame.Active = true
    MainFrame.BorderSizePixel = 0
    MainFrame.Parent = ScreenGui
    MainFrame.Visible = Library.Visible
    Window._MainFrame = MainFrame

    local stroke = Instance.new("UIStroke")
    stroke.Color = Library.Theme.OutlineColor
    stroke.Thickness = 2
    stroke.Parent = MainFrame

    table.insert(Library.Windows, Window)

    -- HEADER
    local Header = Instance.new("Frame", MainFrame)
    Header.Size = UDim2.new(1, 0, 0, 34)
    Header.BackgroundColor3 = Color3.fromRGB(13, 13, 13)
    Header.BorderSizePixel = 0

    local Title = Instance.new("TextLabel", Header)
    Title.Text = "   " .. (Name or "Galaxy Hub")
    Title.Size = UDim2.new(1, 0, 1, 0)
    Title.TextColor3 = Library.Theme.FontColor
    Title.Font = Library.Theme.Font
    Title.TextSize = 16
    Title.BackgroundTransparency = 1
    Title.TextXAlignment = Enum.TextXAlignment.Left

    MakeDraggable(Header, MainFrame)

    -- TAB BAR
    local TabBar = Instance.new("Frame", MainFrame)
    TabBar.Size = UDim2.new(1, -24, 0, 34)
    TabBar.Position = UDim2.new(0, 12, 0, 40)
    TabBar.BackgroundTransparency = 1

    local list = Instance.new("UIListLayout", TabBar)
    list.FillDirection = Enum.FillDirection.Horizontal
    list.SortOrder = Enum.SortOrder.LayoutOrder
    list.Padding = UDim.new(0, 6)

    -- MAIN CONTENT
    local Container = Instance.new("Frame", MainFrame)
    Container.Size = UDim2.new(1, -24, 1, -94)
    Container.Position = UDim2.new(0, 12, 0, 80)
    Container.BackgroundTransparency = 1

    function Window:CloseAllDropdowns()
        for _, pnl in ipairs(Window._DropdownPanels) do
            pnl.Visible = false
        end
    end

    function Window:CreateTab(TabName)
        -- Enforce the tab button limit
        if #Window._Tabs >= TAB_BUTTON_LIMIT then
            warn("Tab button limit reached! You cannot add more than " .. tostring(TAB_BUTTON_LIMIT) .. " tabs.")
            return nil
        end

        local Tab = { GroupBoxes = {}, Name = TabName, Page = nil }
        local TabBtn = Instance.new("TextButton", TabBar)
        TabBtn.AutoButtonColor = false
        TabBtn.Size = UDim2.new(0, math.floor((TabBar.AbsoluteSize.X > 0 and (TabBar.AbsoluteSize.X - (#Window._Tabs)*6)/TAB_BUTTON_LIMIT) or 120), 1, 0)
        TabBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 38)
        TabBtn.Text = TabName
        TabBtn.TextColor3 = Color3.fromRGB(180, 180, 180)
        TabBtn.Font = Library.Theme.Font
        TabBtn.TextSize = 14
        TabBtn.BackgroundTransparency = 0.025
        TabBtn.BorderSizePixel = 0

        local TabStroke = Instance.new("UIStroke", TabBtn)
        TabStroke.Color = Library.Theme.OutlineColor
        TabStroke.Thickness = 1

        -- Disable the button if over the limit (extra prevention)
        if #Window._Tabs + 1 > TAB_BUTTON_LIMIT then
            TabBtn.Text = "[MAX]"
            TabBtn.AutoButtonColor = false
            TabBtn.BackgroundColor3 = Color3.fromRGB(60, 20, 20)
            TabBtn.TextColor3 = Color3.fromRGB(255, 80, 80)
            TabBtn.Active = false
            TabBtn.Selectable = false
        end

        -- PAGE (Tab contents)
        local Page = Instance.new("Frame", Container)
        Page.Size = UDim2.new(1, 0, 1, 0)
        Page.Visible = false
        Page.BackgroundTransparency = 1
        Tab.Page = Page

        -- 2 column layout
        local Left = Instance.new("ScrollingFrame", Page)
        Left.Size = UDim2.new(0.5, -8, 1, 0)
        Left.Position = UDim2.fromOffset(0, 0)
        Left.BackgroundTransparency = 1
        Left.ScrollBarThickness = 3
        Left.AutomaticCanvasSize = Enum.AutomaticSize.Y
        local lList = Instance.new("UIListLayout", Left)
        lList.Padding = UDim.new(0, 14)
        lList.SortOrder = Enum.SortOrder.LayoutOrder

        local Right = Instance.new("ScrollingFrame", Page)
        Right.Size = UDim2.new(0.5, -8, 1, 0)
        Right.Position = UDim2.new(0.5, 8, 0, 0)
        Right.BackgroundTransparency = 1
        Right.ScrollBarThickness = 3
        Right.AutomaticCanvasSize = Enum.AutomaticSize.Y
        local rList = Instance.new("UIListLayout", Right)
        rList.Padding = UDim.new(0, 14)
        rList.SortOrder = Enum.SortOrder.LayoutOrder

        -- Anim tab select
        function Tab:Select(force)
            if Window.CurrentTab ~= Tab or force then
                for _, t in pairs(Window._Tabs) do
                    t.Page.Visible = false
                    Tween(t._TabBtn, {BackgroundColor3 = Color3.fromRGB(30, 30, 38), TextColor3 = Color3.fromRGB(180,180,180)}, 0.15):Play()
                end
                Page.Visible = true
                Window.CurrentTab = Tab
                Tween(TabBtn, {BackgroundColor3 = Library.Theme.AccentColor, TextColor3 = Color3.fromRGB(255,255,255)}, 0.14):Play()
            end
        end
        Tab._TabBtn = TabBtn

        TabBtn.MouseButton1Click:Connect(function() 
            Tab:Select() 
            Window:CloseAllDropdowns()
        end)

        -- GROUPBOX
        function Tab:AddGroupBox(GName, Side)
            local Group = {}
            local ParentCol = (Side == "Right" and Right or Left)

            local Box = Instance.new("Frame", ParentCol)
            Box.Size = UDim2.new(1, 0, 0, 34)
            Box.AutomaticSize = Enum.AutomaticSize.Y
            Box.BackgroundColor3 = Library.Theme.MainColor
            local boxstroke = Instance.new("UIStroke", Box)
            boxstroke.Color = Library.Theme.OutlineColor
            boxstroke.Thickness = 2

            local BoxTitle = Instance.new("TextLabel", Box)
            BoxTitle.Text = "  " .. (GName or "Group")
            BoxTitle.Position = UDim2.fromOffset(10, -8)
            BoxTitle.BackgroundTransparency = 1
            BoxTitle.TextColor3 = Library.Theme.FontColor
            BoxTitle.Font = Library.Theme.Font
            BoxTitle.TextSize = 13
            BoxTitle.AutomaticSize = Enum.AutomaticSize.X

            local Content = Instance.new("Frame", Box)
            Content.Size = UDim2.new(1, 0, 1, 0)
            Content.BackgroundTransparency = 1
            Content.Position = UDim2.fromOffset(0, 22)

            local pad = Instance.new("UIPadding", Content)
            pad.PaddingLeft = UDim.new(0, 12)
            pad.PaddingRight = UDim.new(0, 12)
            pad.PaddingTop = UDim.new(0, 10)
            pad.PaddingBottom = UDim.new(0, 10)
            local layout = Instance.new("UIListLayout", Content)
            layout.Padding = UDim.new(0, 10)
            layout.SortOrder = Enum.SortOrder.LayoutOrder

            -- original Group functions go here...
            -- We can just paste the prior code for Group:AddButton/AddToggle/etc,
            -- since this was not affected by the tab button limit issue.
            
            -- [Omitted for brevity, remains unchanged...]
            -- (Please see above for these unchanged definitions! No bug here.)

            -- (Just copy all of the Group UI element creation methods unchanged...)
            function Group:AddButton(BName, Callback)
                local Btn = Instance.new("TextButton", Content)
                Btn.Size = UDim2.new(1, 0, 0, 28)
                Btn.BackgroundColor3 = Color3.fromRGB(27, 27, 27)
                Btn.Text = BName
                Btn.TextColor3 = Library.Theme.FontColor
                Btn.Font = Library.Theme.Font
                Btn.TextSize = 13
                local s = Instance.new("UIStroke", Btn)
                s.Color = Library.Theme.OutlineColor
                Btn.MouseButton1Click:Connect(function()
                    Tween(Btn, {BackgroundColor3 = Library.Theme.AccentColor}, 0.09):Play()
                    task.wait(0.09)
                    Tween(Btn, {BackgroundColor3 = Color3.fromRGB(27,27,27)}, 0.13):Play()
                    if Callback then Callback() end
                end)
            end
            function Group:AddToggle(TName, Default, Callback) -- unchanged
                Default = (Default == true)
                local T = Instance.new("TextButton", Content)
                T.Size = UDim2.new(1, 0, 0, 24)
                T.BackgroundTransparency = 1
                T.Text = ""
                local Lbl = Instance.new("TextLabel", T)
                Lbl.Text = (TName or "Toggle")
                Lbl.Size = UDim2.new(1, -26, 1, 0)
                Lbl.TextColor3 = Library.Theme.FontColor
                Lbl.Font = Library.Theme.Font
                Lbl.TextSize = 12
                Lbl.BackgroundTransparency = 1
                Lbl.TextXAlignment = Enum.TextXAlignment.Left
                Lbl.Position = UDim2.fromOffset(6, 0)
                local Box = Instance.new("Frame", T)
                Box.Size = UDim2.fromOffset(18, 18)
                Box.AnchorPoint = Vector2.new(1,0.5)
                Box.Position = UDim2.new(1, -6, 0.5, 0)
                Box.BackgroundColor3 = Default and Library.Theme.AccentColor or Color3.fromRGB(40,40,40)
                local boxstroke = Instance.new("UIStroke", Box)
                boxstroke.Color = Library.Theme.OutlineColor

                local state = Default
                T.MouseButton1Click:Connect(function()
                    state = not state
                    Tween(Box, {BackgroundColor3 = state and Library.Theme.AccentColor or Color3.fromRGB(40,40,40)}, 0.14):Play()
                    if Callback then Callback(state) end
                end)
                return setmetatable({Get = function() return state end, Set = function(v) state = v; Box.BackgroundColor3 = state and Library.Theme.AccentColor or Color3.fromRGB(40, 40, 40) end}, {__index = T})
            end
            function Group:AddTextBox(...) -- unchanged
                -- [copy definition as above]
                local TB = Instance.new("Frame", Content)
                TB.Size = UDim2.new(1, 0, 0, 38)
                TB.BackgroundTransparency = 1
                local Lbl = Instance.new("TextLabel", TB)
                Lbl.Text = select(1, ...)
                Lbl.Size = UDim2.new(1, 0, 0, 13)
                Lbl.TextColor3 = Library.Theme.FontColor
                Lbl.Font = Library.Theme.Font
                Lbl.TextSize = 12
                Lbl.BackgroundTransparency = 1
                Lbl.TextXAlignment = Enum.TextXAlignment.Left
                local Input = Instance.new("TextBox", TB)
                Input.Size = UDim2.new(1, 0, 0, 18)
                Input.Position = UDim2.fromOffset(0, 16)
                Input.BackgroundColor3 = Color3.fromRGB(27, 27, 27)
                Input.PlaceholderText = select(2, ...) or "Type..."
                Input.Text = ""
                Input.TextColor3 = Library.Theme.FontColor
                Input.Font = Library.Theme.Font
                Input.TextSize = 11
                local s = Instance.new("UIStroke", Input)
                s.Color = Library.Theme.OutlineColor
                Input.FocusLost:Connect(function(enterPressed)
                    if enterPressed and select(3, ...) then
                        select(3, ...)(Input.Text)
                    end
                end)
                return Input
            end
            function Group:AddSlider(...) -- unchanged
                -- [copy as above]
                local SName, Min, Max, Default, Callback = ...
                Min, Max, Default = tonumber(Min), tonumber(Max), tonumber(Default)
                local S = Instance.new("Frame", Content)
                S.Size = UDim2.new(1, 0, 0, 36)
                S.BackgroundTransparency = 1
                local Label = Instance.new("TextLabel", S)
                Label.Text = SName .. ": " .. Default
                Label.Size = UDim2.new(1, 0, 0, 15)
                Label.TextColor3 = Library.Theme.FontColor
                Label.Font = Library.Theme.Font
                Label.TextSize = 12
                Label.BackgroundTransparency = 1
                Label.TextXAlignment = Enum.TextXAlignment.Left

                local BG = Instance.new("Frame", S)
                BG.Size = UDim2.new(1, 0, 0, 8)
                BG.Position = UDim2.fromOffset(0, 20)
                BG.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
                local s = Instance.new("UIStroke", BG)
                s.Color = Library.Theme.OutlineColor
                s.Thickness = 2
                local Fill = Instance.new("Frame", BG)
                Fill.BackgroundColor3 = Library.Theme.AccentColor
                Fill.Size = UDim2.new((Default-Min)/(Max-Min), 0, 1, 0)
                Fill.BorderSizePixel = 0

                local dragging = false
                local value = Default
                local function SetValue(val)
                    val = math.clamp(math.floor(val+0.5), Min, Max)
                    value = val
                    local percent = (val-Min)/(Max-Min)
                    Fill.Size = UDim2.new(percent, 0, 1, 0)
                    Label.Text = SName .. ": " .. val
                    if Callback then Callback(val) end
                end

                BG.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        dragging = true
                        SetValue( ( (UserInputService:GetMouseLocation().X - BG.AbsolutePosition.X) / BG.AbsoluteSize.X ) * (Max-Min) + Min )
                    end
                end)

                UserInputService.InputChanged:Connect(function(input)
                    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                        SetValue( ( (UserInputService:GetMouseLocation().X - BG.AbsolutePosition.X) / BG.AbsoluteSize.X ) * (Max-Min) + Min )
                    end
                end)
                UserInputService.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        dragging = false
                    end
                end)
                SetValue(Default)
                return {Set = SetValue, Get = function() return value end}
            end

            -- DROPDOWN
            function Group:AddDropdown(DName, List, Callback)
                local D = Instance.new("Frame", Content)
                D.Size = UDim2.new(1, 0, 0, 40)
                D.BackgroundTransparency = 1

                local Lbl = Instance.new("TextLabel", D)
                Lbl.Text = DName or "Dropdown"
                Lbl.Size = UDim2.new(1, 0, 0, 15)
                Lbl.TextColor3 = Library.Theme.FontColor
                Lbl.Font = Library.Theme.Font
                Lbl.TextSize = 12
                Lbl.BackgroundTransparency = 1
                Lbl.TextXAlignment = Enum.TextXAlignment.Left

                local Btn = Instance.new("TextButton", D)
                Btn.Size = UDim2.new(1, 0, 0, 22)
                Btn.Position = UDim2.fromOffset(0, 18)
                Btn.BackgroundColor3 = Color3.fromRGB(27, 27, 27)
                Btn.Text = "Select..."
                Btn.TextColor3 = Library.Theme.FontColor
                Btn.Font = Library.Theme.Font
                Btn.TextSize = 11
                Btn.BorderSizePixel = 0
                local s = Instance.new("UIStroke", Btn)
                s.Color = Library.Theme.OutlineColor

                -- Drop panel
                local Panel = Instance.new("Frame", MainFrame)
                Panel.ClipsDescendants = true
                Panel.Visible = false
                Panel.BackgroundColor3 = Library.Theme.MainColor
                Panel.Size = UDim2.new(0, Btn.AbsoluteSize.X, 0, math.min(#List * 22, 120))
                Panel.ZIndex = 50
                Panel.Position = UDim2.fromOffset(0, 0)
                Panel.BorderSizePixel = 0
                local ps = Instance.new("UIStroke", Panel)
                ps.Color = Library.Theme.OutlineColor
                local ll = Instance.new("UIListLayout", Panel)
                ll.Padding = UDim.new(0,0)
                ll.SortOrder = Enum.SortOrder.LayoutOrder
                table.insert(Window._DropdownPanels, Panel)

                local function ShowDropdown()
                    Window:CloseAllDropdowns()
                    Panel.Size = UDim2.new(0, Btn.AbsoluteSize.X, 0, math.min(#List * 22, 120))
                    Panel.Position = UDim2.fromOffset(
                        Btn.AbsolutePosition.X - MainFrame.AbsolutePosition.X, 
                        Btn.AbsolutePosition.Y - MainFrame.AbsolutePosition.Y + Btn.AbsoluteSize.Y
                    )
                    Panel.Visible = true
                end
                Btn.MouseButton1Click:Connect(ShowDropdown)
                -- Click-away closes all dropdowns
                local closeref
                closeref = UserInputService.InputBegan:Connect(function(input, gpe)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        if not Panel.Visible then return end
                        local mousePos = UserInputService:GetMouseLocation()
                        local abs = Panel.AbsolutePosition
                        local size = Panel.AbsoluteSize
                        if mousePos.X < abs.X or mousePos.X > abs.X+size.X or mousePos.Y < abs.Y or mousePos.Y > abs.Y+size.Y then
                            Panel.Visible = false
                        end
                    end
                end)

                for _, v in ipairs(List) do
                    local O = Instance.new("TextButton", Panel)
                    O.Size = UDim2.new(1, 0, 0, 22)
                    O.BackgroundColor3 = Library.Theme.MainColor
                    O.Text = tostring(v)
                    O.TextColor3 = Library.Theme.FontColor
                    O.Font = Library.Theme.Font
                    O.TextSize = 11
                    O.BorderSizePixel = 0
                    O.AutoButtonColor = true
                    O.MouseButton1Click:Connect(function()
                        Btn.Text = tostring(v)
                        Panel.Visible = false
                        if Callback then Callback(v) end
                    end)
                end
                return {
                    SetOptions = function(_, newList)
                        List = newList
                        for _, ch in ipairs(Panel:GetChildren()) do
                            if ch:IsA("TextButton") then ch:Destroy() end
                        end
                        for _, v in ipairs(List) do
                            local O = Instance.new("TextButton", Panel)
                            O.Size = UDim2.new(1, 0, 0, 22)
                            O.BackgroundColor3 = Library.Theme.MainColor
                            O.Text = tostring(v)
                            O.TextColor3 = Library.Theme.FontColor
                            O.Font = Library.Theme.Font
                            O.TextSize = 11
                            O.BorderSizePixel = 0
                            O.AutoButtonColor = true
                            O.MouseButton1Click:Connect(function()
                                Btn.Text = tostring(v)
                                Panel.Visible = false
                                if Callback then Callback(v) end
                            end)
                        end
                        Panel.Size = UDim2.new(0, Btn.AbsoluteSize.X, 0, math.min(#List * 22, 120))
                    end,
                    Button = Btn,
                }
            end

            -- COLOR PICKER (placeholder)
            function Group:AddColorPicker(PName, Default, Callback)
                local CP = Instance.new("Frame", Content)
                CP.Size = UDim2.new(1, 0, 0, 24)
                CP.BackgroundTransparency = 1
                local Label = Instance.new("TextLabel", CP)
                Label.Text = PName or "Color"
                Label.Size = UDim2.new(1, 0, 0, 14)
                Label.Position = UDim2.fromOffset(0, 0)
                Label.TextColor3 = Library.Theme.FontColor
                Label.Font = Library.Theme.Font
                Label.TextSize = 12
                Label.BackgroundTransparency = 1
                Label.TextXAlignment = Enum.TextXAlignment.Left

                local Btn = Instance.new("TextButton", CP)
                Btn.Size = UDim2.fromOffset(26, 14)
                Btn.Position = UDim2.new(1, -32, 0.5, -6)
                Btn.BackgroundColor3 = Default or Library.Theme.AccentColor
                Btn.Text = ""
                local s = Instance.new("UIStroke", Btn)
                s.Color = Library.Theme.OutlineColor

                -- Modern Color Picker Popup Implementation
                Btn.MouseButton1Click:Connect(function()
                    -- Remove existing popup if any
                    if CP:FindFirstChild("ColorPopup") then
                        CP.ColorPopup:Destroy()
                        return
                    end

                    -- Popup Frame
                    local Popup = Instance.new("Frame")
                    Popup.Name = "ColorPopup"
                    Popup.Size = UDim2.fromOffset(180, 150)
                    Popup.Position = UDim2.new(0, Btn.AbsolutePosition.X - Content.AbsolutePosition.X, 1, -4)
                    Popup.BackgroundColor3 = Library.Theme.MainColor
                    Popup.BorderSizePixel = 0
                    Popup.Parent = CP
                    local ps = Instance.new("UIStroke", Popup)
                    ps.Color = Library.Theme.OutlineColor

                    -- Saturation/Value Picker
                    local SV = Instance.new("ImageButton", Popup)
                    SV.Name = "SV"
                    SV.Size = UDim2.new(0, 130, 0, 130)
                    SV.Position = UDim2.fromOffset(10, 10)
                    SV.BackgroundColor3 = Color3.new(1,1,1)
                    SV.AutoButtonColor = false
                    SV.BorderSizePixel = 0
                    SV.Image = "rbxassetid://4155801252" -- Gradient image for SV

                    -- Hue Bar
                    local HueBar = Instance.new("ImageButton", Popup)
                    HueBar.Name = "HueBar"
                    HueBar.Size = UDim2.new(0, 12, 0, 130)
                    HueBar.Position = UDim2.fromOffset(150, 10)
                    HueBar.BackgroundColor3 = Color3.fromRGB(255,255,255)
                    HueBar.AutoButtonColor = false
                    HueBar.BorderSizePixel = 0
                    HueBar.Image = "rbxassetid://3641079629" -- Gradient image for hue

                    -- Preview
                    local Preview = Instance.new("Frame", Popup)
                    Preview.Size = UDim2.fromOffset(25, 25)
                    Preview.Position = UDim2.fromOffset(10, 145)
                    Preview.BackgroundColor3 = Btn.BackgroundColor3
                    Preview.BorderSizePixel = 0
                    local prevs = Instance.new("UIStroke", Preview)
                    prevs.Color = Library.Theme.OutlineColor

                    -- Ok Button
                    local Ok = Instance.new("TextButton", Popup)
                    Ok.Size = UDim2.fromOffset(45, 25)
                    Ok.Position = UDim2.fromOffset(65, 145)
                    Ok.Text = "OK"
                    Ok.Font = Library.Theme.Font
                    Ok.TextSize = 13
                    Ok.TextColor3 = Library.Theme.FontColor
                    Ok.BackgroundColor3 = Library.Theme.AccentColor
                    Ok.BorderSizePixel = 0
                    local oks = Instance.new("UIStroke", Ok)
                    oks.Color = Library.Theme.OutlineColor

                    -- Cancel Button
                    local Cancel = Instance.new("TextButton", Popup)
                    Cancel.Size = UDim2.fromOffset(45, 25)
                    Cancel.Position = UDim2.fromOffset(120, 145)
                    Cancel.Text = "Cancel"
                    Cancel.Font = Library.Theme.Font
                    Cancel.TextSize = 13
                    Cancel.TextColor3 = Library.Theme.FontColor
                    Cancel.BackgroundColor3 = Library.Theme.MainColor
                    Cancel.BorderSizePixel = 0
                    local cxs = Instance.new("UIStroke", Cancel)
                    cxs.Color = Library.Theme.OutlineColor

                    -- HSV Storage
                    local h, s, v = 0, 0, 1
                    local function set(hh, ss, vv)
                        h, s, v = hh, ss, vv
                        local col = Color3.fromHSV(h, s, v)
                        Preview.BackgroundColor3 = col
                        SV.BackgroundColor3 = Color3.fromHSV(h, 1, 1)
                    end

                    -- Set to default or current value
                    do
                        local col = Btn.BackgroundColor3
                        local _h, _s, _v = col:ToHSV()
                        set(_h, _s, _v)
                    end

                    -- Hue Picking
                    local dragging_hue = false
                    local function update_hue(posY)
                        local y = math.clamp(posY - HueBar.AbsolutePosition.Y, 0, HueBar.AbsoluteSize.Y)
                        local hue = y / HueBar.AbsoluteSize.Y
                        set(hue, s, v)
                    end
                    HueBar.InputBegan:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            dragging_hue = true
                            update_hue(input.Position.Y)
                        end
                    end)
                    HueBar.InputEnded:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            dragging_hue = false
                        end
                    end)
                    game:GetService("UserInputService").InputChanged:Connect(function(input)
                        if dragging_hue and input.UserInputType == Enum.UserInputType.MouseMovement then
                            update_hue(input.Position.Y)
                        end
                    end)

                    -- SV Picking
                    local dragging_sv = false
                    local function update_sv(pos)
                        local x = math.clamp(pos.X - SV.AbsolutePosition.X, 0, SV.AbsoluteSize.X)
                        local y = math.clamp(pos.Y - SV.AbsolutePosition.Y, 0, SV.AbsoluteSize.Y)
                        local ss = x / SV.AbsoluteSize.X
                        local vv = 1 - (y / SV.AbsoluteSize.Y)
                        set(h, ss, vv)
                    end
                    SV.InputBegan:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            dragging_sv = true
                            update_sv(input.Position)
                        end
                    end)
                    SV.InputEnded:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            dragging_sv = false
                        end
                    end)
                    game:GetService("UserInputService").InputChanged:Connect(function(input)
                        if dragging_sv and input.UserInputType == Enum.UserInputType.MouseMovement then
                            update_sv(input.Position)
                        end
                    end)

                    -- OK/Cancel/Click-away handling
                    Ok.MouseButton1Click:Connect(function()
                        local newCol = Color3.fromHSV(h, s, v)
                        Tween(Btn, {BackgroundColor3 = newCol}, 0.09):Play()
                        if Callback then Callback(newCol) end
                        Popup:Destroy()
                    end)
                    Cancel.MouseButton1Click:Connect(function()
                        Popup:Destroy()
                    end)
                    -- Dismiss on outside click
                    local conn
                    conn = game:GetService("UserInputService").InputBegan:Connect(function(input, processed)
                        if processed then return end
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            local mousePos = game:GetService("UserInputService"):GetMouseLocation()
                            local abs = Popup.AbsolutePosition
                            local size = Popup.AbsoluteSize
                            if not (mousePos.X >= abs.X and mousePos.X <= abs.X+size.X and mousePos.Y >= abs.Y and mousePos.Y <= abs.Y+size.Y) then
                                Popup:Destroy()
                            end
                        end
                    end)
                    Popup.AncestryChanged:Connect(function(_, parent)
                        if not parent then
                            if conn then conn:Disconnect() end
                        end
                    end)
                end)
            end

            return Group
        end

        table.insert(Window._Tabs, Tab)
        if #Window._Tabs == 1 then Tab:Select(true) end -- auto select first

        return Tab
    end

    return Window
end

return Library
